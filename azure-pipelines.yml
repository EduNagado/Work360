# =====================================================
# Azure DevOps Pipeline - Work360 API
# CI/CD com Docker + JUnit + Deploy no Azure Web App
# =====================================================

trigger:
  branches:
    include:
      - master

variables:
  - group: 'variaveis-segredas'

  - name: appName
    value: 'work360-api'

  - name: acrName
    value: 'work360acr'

  - name: imageName
    value: 'work360-api'

  - name: tag
    value: '$(Build.BuildId)'

  - name: resourceGroup
    value: 'work360-dev-rg'

  - name: location
    value: 'brazilsouth'

  - name: appServicePlan
    value: 'work360-plan'

# =====================================================
# üß± STAGE 1 ‚Äî BUILD + TEST + DOCKER PUSH
# =====================================================
stages:
  - stage: Build
    displayName: "Build + Testes JUnit + Docker Push"
    jobs:
      - job: BuildAndPush
        displayName: "Build, Test and Push Docker Image"
        pool:
          vmImage: 'ubuntu-latest'

        steps:
          # ----------------------------------------
          # üîÅ Checkout
          # ----------------------------------------
          - checkout: self

          # ----------------------------------------
          # üß™ JUnit Tests
          # ----------------------------------------
          - task: Gradle@3
            displayName: 'Executar Testes JUnit'
            inputs:
              gradleWrapperFile: 'gradlew'
              tasks: 'clean test'
              publishJUnitResults: true
              testResultsFiles: '**/build/test-results/test/*.xml'

          # ----------------------------------------
          # üîê Azure Login + Create ACR
          # ----------------------------------------
          - task: AzureCLI@2
            displayName: 'Login no Azure e criar ACR se n√£o existir'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "üîé Verificando se o ACR existe..."
                EXIST=$(az acr show -n $(acrName) --query "name" -o tsv 2>/dev/null || echo "")

                if [ -z "$EXIST" ]; then
                  echo "üì¶ ACR n√£o existe. Criando..."
                  az acr create \
                    --name $(acrName) \
                    --resource-group $(resourceGroup) \
                    --sku Standard \
                    --location $(location) \
                    --admin-enabled true
                else
                  echo "‚úî ACR j√° existe."
                fi

                echo "üîê Realizando login no ACR..."
                az acr login --name $(acrName)

          # ----------------------------------------
          # üê≥ Build e Push da imagem Docker
          # ----------------------------------------
          - script: |
              echo "üê≥ Build da imagem..."
              docker build -t $(acrName).azurecr.io/$(imageName):$(tag) .

              echo "‚¨Ü Enviando imagem para o ACR..."
              docker push $(acrName).azurecr.io/$(imageName):$(tag)
            displayName: 'Build e Push da imagem Docker'

          # ----------------------------------------
          # üì¶ Publicar artefatos da Build
          # ----------------------------------------
          - publish: $(System.DefaultWorkingDirectory)
            artifact: drop


  # =====================================================
  # üöÄ STAGE 2 ‚Äî DEPLOY + API TESTS
  # =====================================================
  - stage: Deploy
    displayName: "Deploy no Azure Web App e Testes"
    dependsOn: Build
    condition: succeeded()

    jobs:
      - deployment: DeployWebApp
        environment: 'dev'
        pool:
          vmImage: 'ubuntu-latest'

        strategy:
          runOnce:
            deploy:
              steps:
                # ----------------------------------------
                # üèó Criar Resource Group / App Service Plan
                # ----------------------------------------
                - task: AzureCLI@2
                  displayName: 'Criar Resource Group e App Service Plan'
                  inputs:
                    azureSubscription: '$(azureServiceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "üîé Verificando Resource Group..."
                      RG=$(az group show -n $(resourceGroup) --query "name" -o tsv 2>/dev/null || echo "")

                      if [ -z "$RG" ]; then
                        echo "üì¶ Criando Resource Group..."
                        az group create --name $(resourceGroup) --location $(location)
                      else
                        echo "‚úî Resource Group j√° existe."
                      fi

                      echo "üîé Verificando App Service Plan..."
                      PLAN=$(az appservice plan show --name $(appServicePlan) --resource-group $(resourceGroup) --query "name" -o tsv 2>/dev/null || echo "")

                      if [ -z "$PLAN" ]; then
                        echo "üì¶ Criando App Service Plan..."
                        az appservice plan create \
                          --name $(appServicePlan) \
                          --resource-group $(resourceGroup) \
                          --sku B1 \
                          --is-linux
                      else
                        echo "‚úî App Service Plan j√° existe."
                      fi

                # ----------------------------------------
                # üåê Criar Web App ou atualizar imagem
                # ----------------------------------------
                - task: AzureCLI@2
                  displayName: 'Criar Web App ou atualizar imagem'
                  inputs:
                    azureSubscription: '$(azureServiceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      APP=$(az webapp show --name $(appName) --resource-group $(resourceGroup) --query "name" -o tsv 2>/dev/null || echo "")

                      if [ -z "$APP" ]; then
                        echo "üåê Criando Web App..."
                        az webapp create \
                          --resource-group $(resourceGroup) \
                          --plan $(appServicePlan) \
                          --name $(appName) \
                          --deployment-container-image-name $(acrName).azurecr.io/$(imageName):$(tag)
                      else
                        echo "‚ôª Atualizando imagem do Web App..."
                        az webapp config container set \
                          --name $(appName) \
                          --resource-group $(resourceGroup) \
                          --docker-custom-image-name $(acrName).azurecr.io/$(imageName):$(tag)
                      fi

                # ----------------------------------------
                # üîÑ Restart Web App
                # ----------------------------------------
                - task: AzureCLI@2
                  displayName: 'Reiniciar Web App'
                  inputs:
                    azureSubscription: '$(azureServiceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "üîÑ Reiniciando aplica√ß√£o..."
                      az webapp restart --name $(appName) --resource-group $(resourceGroup)

                # ----------------------------------------
                # üß™ Testes de API P√≥s-Deploy
                # ----------------------------------------
                - task: CmdLine@2
                  displayName: 'Executar Testes de API'
                  inputs:
                    script: |
                      echo "=== INICIANDO TESTES DE API ==="
                      API_URL="https://work360-api.azurewebsites.net"

                      echo "‚û° Testando Swagger UI..."
                      SWAGGER_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL/swagger-ui/swagger-ui/index.html" || echo "000")
                      if [ "$SWAGGER_RESPONSE" -ne 200 ]; then
                        echo "‚ùå Swagger fora do ar!"
                        exit 1
                      fi

                      echo "‚û° Testando API Docs..."
                      API_DOCS_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL/v3/api-docs" || echo "000")
                      if [ "$API_DOCS_RESPONSE" -ne 200 ]; then
                        echo "‚ùå API Docs fora do ar!"
                        exit 1
                      fi

                      echo "‚û° Testando LOGIN..."
                      LOGIN_RESPONSE=$(curl -s -o login.json -w "%{http_code}" \
                        -X POST "$API_URL/login" \
                        -H "Content-Type: application/json" \
                        -d '{
                          "email": "eduardo.nagado@gmail.com",
                          "senha": "Dudu2004-"
                        }')

                      echo "HTTP: $LOGIN_RESPONSE"

                      if [ "$LOGIN_RESPONSE" -ne 200 ]; then
                        echo "‚ùå Falha no login!"
                        cat login.json
                        exit 1
                      fi

                      TOKEN=$(jq -r '.token' login.json 2>/dev/null)
                      if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
                        echo "‚ùå Login retornou 200 mas sem token!"
                        exit 1
                      fi

                      echo "‚úî TOKEN recebido com sucesso!"
                      rm -f login.json
                      echo "=== TESTES OK ==="
